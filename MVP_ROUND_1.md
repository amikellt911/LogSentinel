# LogSentinel - 第一轮 MVP (毕业设计)

## 项目背景与方法论
本项目名为 **LogSentinel**，是一个高性能日志分析服务。作为毕业设计项目，它采用 **迭代开发法 (Iterative Development)** 进行构建。
目前的版本是 **第一轮 MVP (Minimum Viable Product，最小可行性产品)**，旨在验证核心架构的可行性，打通从 HTTP 接收、持久化存储到 AI 分析的基础链路。

## 任务书与长期愿景 (Project Mission)
> **注意**：以下内容摘自项目任务书，代表了 LogSentinel 的**最终形态与设计目标**。当前 MVP 版本可能尚未完全实现所有特性，但未来的架构决策（如技术选型、模块划分）应以此为指导方向。

**背景**：随着微服务与云原生架构普及，日志数据呈指数级增长，传统基于关键词和阈值的监控手段在未知异常检测和语义化根因分析方面暴露出严重不足，导致运维人员深陷信息过载、告警风暴和响应滞后的困境。

**目标**：本课题设计并实现一套异步事件驱动、AI 语义增强的轻量级实时日志监控平台 LogSentinel，一体化解决海量日志高并发接收、慢速大模型推理与快速告警闭环三大矛盾。

**核心设计**：
- **高性能架构**：采用多 Reactor 网络框架，通过无锁队列将 JSON 日志先写入本地 WAL 追加文件，每秒批量 fsync；IO 线程仅负责接收与入队。
- **智能调度**：后台工作线程按动态批大小和令牌桶限速调用外部大模型 API，内置重试、熔断及 Mock 降级策略，减少端到端延迟。
- **AI 引擎**：提出 AI Engine 抽象层与 Prompt 模板热管理，支持 GPT、Claude、本地等多模型热插拔，驱动 LLM 输出结构化异常分类、语义摘要与风险分值，并写入关系型存储供秒级检索。
- **可视化与告警**：Web 控制台提供实时 Dashboard、队列深度、AI 调用耗时等指标可视化，允许用户在线编辑 Prompt、配置风险阈值，并基于 Webhook 将不同等级告警推送至飞书、钉钉。

## MVP 核心目标
本轮迭代主要关注系统的**核心骨架**搭建，确保数据流转通畅，暂不追求极致的性能优化或复杂的业务逻辑。
- **验证架构**：验证 Reactor 模式 + 线程池 + SQLite 的架构是否能够正常工作。
- **打通链路**：实现 "接收 -> 存储 -> (预留)分析" 的完整闭环。

## 当前架构与模块详解 (MVP 版本)

### 1. HTTP 接入层 (`http/`)
- **功能**：基于 MiniMuduo 网络库实现的轻量级 HTTP 服务器。
- **当前实现**：
  - `HttpServer`: 负责启动 TCP 服务器，注册连接和消息回调。
  - `HttpContext`: 解析 HTTP 请求报文，维护解析状态机。
  - `HttpResponse`: 封装 HTTP 响应，支持状态码和 Header 设置。
  - **MVP 特性**：能够解析基本的 POST 请求，生成 `trace_id`，采用简单的回调机制处理路由。

### 2. 任务调度层 (`threadpool/`)
- **功能**：解耦网络 I/O 与业务逻辑。
- **当前实现**：
  - `ThreadPool`: 一个固定线程数的线程池，支持任务队列和工作窃取（Work Stealing）。
  - **MVP 特性**：HTTP 线程将耗时的存储任务提交到线程池，避免阻塞网络服务。

### 3. 持久化层 (`persistence/`)
- **功能**：数据的落地存储。
- **当前实现**：
  - `SqliteLogRepository`: 封装 SQLite 操作，管理 `raw_logs` (原始日志) 和 `analysis_results` (分析结果) 两张表。
  - **MVP 特性**：选用 SQLite 便于部署，实现了基础的 CRUD 操作。

### 4. AI 集成层 (`ai/`)
- **功能**：对接外部 AI 能力。
- **当前实现**：
  - `GeminiApiAi`: 通过 `cpr` 库调用本地 Python 代理的 RESTful API。
  - **MVP 特性**：支持基础的 `analyze` 和 `chat` 接口，打通了 C++ 调用 AI 服务的链路。

### 5. 核心领域层 (`core/`)
- **功能**：定义核心数据结构和业务实体。
- **当前实现**：
  - `AnalysisTask`: 简单的结构体，包含 `trace_id` 和原始请求体，用于在各层之间传递数据。

### 6. 工具库 (`util/`)
- **功能**：提供通用的辅助功能。
- **当前实现**：
  - `TraceIdGenerator`: 生成全局唯一的追踪 ID，用于全链路日志追踪。

### 7. 应用程序入口 (`src/`)
- **功能**：组合各模块，启动服务。
- **当前实现**：
  - `main.cpp`: 生产环境的主程序入口。
  - `testserver*.cpp`: 各类集成测试服务器，用于验证不同组合（如 HTTP+线程池+SQLite）。

### 8. 测试套件 (`tests/`)
- **功能**：单元测试和集成测试。
- **当前实现**：
  - 包含针对各模块（http, threadpool, persistence 等）的 GoogleTest 测试用例，确保 MVP 功能的正确性。

## 数据流转 (MVP)
1. **接收**：用户发送 POST 请求到 `/log`。
2. **封装**：服务器生成 `trace_id`，将请求封装为 `AnalysisTask`。
3. **调度**：任务被提交到线程池。
4. **存储**：工作线程调用 `SqliteLogRepository` 将原始日志写入 `raw_logs` 表。
5. **响应**：服务器立即返回 HTTP 202 Accepted 及 `trace_id`，实现异步处理。

## 未来迭代计划
关于项目的详细优化路线图（Roadmap）、架构演进思考以及 AI 上下文管理策略，请参阅项目根目录下的 **`README.md`** 文件。
该文件详细记录了从 MVP 到最终完善版本的规划，包括：
- 架构重构（路由、上下文）
- 性能优化（gRPC、数据库并发）
- 稳定性增强（重试、背压）
- AI 能力深化（RAG、长上下文）

> **后续文档预告**：随着项目推进，我们将创建 **`MVP_ROUND_2.md`** 等文档，详细记录每一轮迭代如何逐步逼近任务书中的最终目标。

---
*本文档记录了 LogSentinel 毕业设计项目第一轮 MVP 的开发状态与架构设计。*
