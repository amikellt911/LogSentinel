<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogSentinel æ§åˆ¶å°</title>
    <!-- 1. å¼•å…¥ Bootstrap CSS (å¸®ä½ æå®šæ ·å¼) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Vue 3 (å¸®ä½ æå®šé€»è¾‘) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 40px; }
        .log-card { transition: all 0.3s; }
        .log-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        /* ç®€å•çš„é£é™©é¢œè‰²å®šä¹‰ */
        .risk-high { border-left: 5px solid #dc3545; }
        .risk-medium { border-left: 5px solid #ffc107; }
        .risk-low { border-left: 5px solid #198754; }
    </style>
</head>
<body>

<div id="app" class="container">
    
    <!-- æ ‡é¢˜æ  -->
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-primary">ğŸ›¡ï¸ LogSentinel</h1>
        <p class="lead text-muted">åŸºäº AI çš„å®æ—¶æ—¥å¿—æ™ºèƒ½åˆ†æç³»ç»Ÿ</p>
    </div>

    <!-- æäº¤åŒºåŸŸ -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">æäº¤æ–°æ—¥å¿—</h5>
            <div class="mb-3">
                <textarea v-model="inputLog" class="form-control" rows="3" placeholder="åœ¨æ­¤ç²˜è´´ç³»ç»ŸæŠ¥é”™æ—¥å¿—..."></textarea>
            </div>
            <button @click="submitLog" :disabled="isProcessing" class="btn btn-primary px-4">
                <span v-if="isProcessing" class="spinner-border spinner-border-sm me-2"></span>
                {{ isProcessing ? 'åˆ†æä¸­...' : 'å¼€å§‹æ™ºèƒ½åˆ†æ' }}
            </button>
        </div>
    </div>

    <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
    <div v-if="currentTask.traceId" class="card shadow-sm log-card" :class="riskClass">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Trace ID: <code>{{ currentTask.traceId }}</code></span>
            <span v-if="currentTask.status === 'finished'" class="badge" :class="riskBadgeClass">
                {{ currentTask.result.risk_level || 'UNKNOWN' }}
            </span>
            <span v-else class="badge bg-secondary">PROCESSING</span>
        </div>
        
        <div class="card-body">
            <!-- åˆ†æä¸­ -->
            <div v-if="currentTask.status === 'pending'" class="text-center py-4 text-muted">
                <div class="spinner-grow text-primary" role="status"></div>
                <p class="mt-2">AI æ­£åœ¨æ€è€ƒæ ¹å› ...</p>
            </div>

            <!-- åˆ†æå®Œæˆ -->
            <div v-else-if="currentTask.status === 'finished'">
                <h5 class="card-title">æ‘˜è¦</h5>
                <p class="card-text">{{ currentTask.result.summary }}</p>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h6>ğŸ” æ ¹æœ¬åŸå›  (Root Cause)</h6>
                        <div class="alert alert-light border">
                            {{ currentTask.result.root_cause }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>ğŸ’¡ ä¿®å¤å»ºè®® (Solution)</h6>
                        <div class="alert alert-success border-0 bg-opacity-10" style="background-color: #d1e7dd;">
                            {{ currentTask.result.solution }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤±è´¥ -->
            <div v-else-if="currentTask.status === 'error'" class="alert alert-danger">
                {{ currentTask.error }}
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;
    const API_BASE = "http://127.0.0.1:8080";

    createApp({
        data() {
            return {
                inputLog: "",
                isProcessing: false,
                currentTask: {
                    traceId: null,
                    status: null, // 'pending', 'finished', 'error'
                    result: {},
                    error: ""
                },
                pollTimer: null
            }
        },
        computed: {
            // æ ¹æ®é£é™©ç­‰çº§åŠ¨æ€æ”¹å˜æ ·å¼
            riskClass() {
                const risk = this.currentTask.result.risk_level;
                if (!risk) return '';
                return `risk-${risk.toLowerCase()}`;
            },
            riskBadgeClass() {
                const risk = (this.currentTask.result.risk_level || '').toLowerCase();
                if (risk === 'high' || risk === 'critical') return 'bg-danger';
                if (risk === 'medium') return 'bg-warning text-dark';
                return 'bg-success';
            }
        },
        methods: {
            async submitLog() {
                if (!this.inputLog.trim()) return;
                
                this.isProcessing = true;
                this.currentTask = { traceId: null, status: 'pending', result: {} };
                
                try {
                    // 1. å‘é€æ—¥å¿—
                    const res = await fetch(`${API_BASE}/logs`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ msg: this.inputLog })
                    });
                    
                    if (!res.ok) throw new Error("æœåŠ¡å™¨ç¹å¿™");
                    
                    const data = await res.json();
                    this.currentTask.traceId = data.trace_id;
                    
                    // 2. å¼€å§‹è½®è¯¢
                    this.startPolling(data.trace_id);
                    
                } catch (e) {
                    this.currentTask.status = 'error';
                    this.currentTask.error = e.message;
                    this.isProcessing = false;
                }
            },
            
            startPolling(traceId) {
                let attempts = 0;
                if (this.pollTimer) clearInterval(this.pollTimer);
                
                this.pollTimer = setInterval(async () => {
                    attempts++;
                    try {
                        const res = await fetch(`${API_BASE}/results/${traceId}`);
                        
                        if (res.status === 200) {
                            // æˆåŠŸæ‹¿åˆ°ç»“æœ
                            const data = await res.json();
                            this.currentTask.result = data.result;
                            this.currentTask.status = 'finished';
                            this.stopPolling();
                        } else if (res.status === 404) {
                            // è¿˜åœ¨å¤„ç†ä¸­ï¼Œç»§ç»­ç­‰å¾…
                            console.log("Waiting for AI...");
                        } else {
                            throw new Error("æŸ¥è¯¢å‡ºé”™");
                        }
                    } catch (e) {
                        console.error(e);
                    }
                    
                    // 30ç§’è¶…æ—¶
                    if (attempts > 30) {
                        this.currentTask.status = 'error';
                        this.currentTask.error = "åˆ†æè¶…æ—¶";
                        this.stopPolling();
                    }
                }, 1000);
            },
            
            stopPolling() {
                clearInterval(this.pollTimer);
                this.isProcessing = false;
            }
        }
    }).mount('#app');
</script>

</body>
</html>