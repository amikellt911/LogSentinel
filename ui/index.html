<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogSentinel å®æ—¶ç›‘æ§</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 { text-align: center; color: var(--primary-color); }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            margin-bottom: 24px;
        }

        textarea {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-family: monospace;
            resize: vertical;
            margin-bottom: 16px;
            box-sizing: border-box;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #94a3b8; cursor: not-allowed; }

        #status { margin-left: 10px; font-size: 0.9em; color: #64748b; }

        /* ç»“æœå±•ç¤ºåŒºåŸŸ */
        .result-box { display: none; border-left: 5px solid #ccc; padding-left: 15px; }
        .result-box.high { border-color: var(--danger); }
        .result-box.medium { border-color: var(--warning); }
        .result-box.low { border-color: var(--success); }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        .bg-high { background-color: var(--danger); }
        .bg-medium { background-color: var(--warning); }
        .bg-low { background-color: var(--success); }
        
        pre {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
        }
    </style>
</head>
<body>

    <h1>ğŸ›¡ï¸ LogSentinel Dashboard</h1>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="card">
        <h3>æäº¤æ—¥å¿—è¿›è¡Œåˆ†æ</h3>
        <textarea id="logInput" placeholder="åœ¨æ­¤ç²˜è´´ç³»ç»Ÿæ—¥å¿—... ä¾‹å¦‚: Critical Error: DB connection failed..."></textarea>
        <div>
            <button id="btnSubmit" onclick="submitLog()">ğŸš€ å¼€å§‹åˆ†æ</button>
            <span id="status"></span>
        </div>
    </div>

    <!-- ç»“æœåŒºåŸŸ -->
    <div id="resultArea" class="card result-box">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>åˆ†ææŠ¥å‘Š</h3>
            <span id="riskBadge" class="badge">Pending</span>
        </div>
        <p><strong>Trace ID:</strong> <code id="traceIdDisplay"></code></p>
        
        <h4>æ‘˜è¦ (Summary)</h4>
        <p id="summaryText">...</p>

        <h4>æ ¹å›  (Root Cause)</h4>
        <p id="rootCauseText">...</p>

        <h4>è§£å†³æ–¹æ¡ˆ (Solution)</h4>
        <pre id="solutionText">...</pre>
    </div>

    <script>
        const SERVER_URL = "http://127.0.0.1:8080";
        let pollInterval = null;

        async function submitLog() {
            const logContent = document.getElementById('logInput').value;
            if (!logContent.trim()) return alert("æ—¥å¿—ä¸èƒ½ä¸ºç©º");

            setLoading(true);
            resetResult();

            try {
                // 1. å‘é€ POST è¯·æ±‚
                const response = await fetch(`${SERVER_URL}/logs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ msg: logContent }) // æ³¨æ„ï¼šC++ç«¯è¦è§£æè¿™ä¸ª json keyï¼Œæˆ–è€…ç›´æ¥å‘ raw string
                });

                if (!response.ok) throw new Error("æäº¤å¤±è´¥");

                const data = await response.json();
                const traceId = data.trace_id;
                
                document.getElementById('status').innerText = `å·²æäº¤ï¼ŒTraceID: ${traceId}ï¼Œåˆ†æä¸­...`;
                document.getElementById('traceIdDisplay').innerText = traceId;
                document.getElementById('resultArea').style.display = 'block';

                // 2. å¼€å§‹è½®è¯¢ GET ç»“æœ
                startPolling(traceId);

            } catch (e) {
                alert("é”™è¯¯: " + e.message);
                setLoading(false);
            }
        }

        function startPolling(traceId) {
            let attempts = 0;
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                attempts++;
                try {
                    const res = await fetch(`${SERVER_URL}/results/${traceId}`);
                    
                    if (res.status === 200) {
                        // æˆåŠŸæ‹¿åˆ°ç»“æœ
                        const data = await res.json();
                        renderResult(data.result); // data.result æ˜¯ AI è¿”å›çš„ JSON å¯¹è±¡
                        clearInterval(pollInterval);
                        setLoading(false);
                        document.getElementById('status').innerText = "âœ… åˆ†æå®Œæˆ";
                    } else if (res.status === 404) {
                        // è¿˜åœ¨å¤„ç†ä¸­
                        document.getElementById('status').innerText = `åˆ†æä¸­... (${attempts}s)`;
                    } else {
                        throw new Error("æœåŠ¡å™¨é”™è¯¯");
                    }
                } catch (e) {
                    console.error("Polling error", e);
                }

                // 30ç§’è¶…æ—¶åœæ­¢
                if (attempts > 30) {
                    clearInterval(pollInterval);
                    setLoading(false);
                    document.getElementById('status').innerText = "âš ï¸ åˆ†æè¶…æ—¶";
                }
            }, 1000); // æ¯ç§’æŸ¥ä¸€æ¬¡
        }

        function renderResult(aiJson) {
            // æ ¹æ® risk_level è®¾ç½®é¢œè‰²
            const box = document.getElementById('resultArea');
            const badge = document.getElementById('riskBadge');
            
            // æ¸…é™¤æ—§ç±»
            box.classList.remove('high', 'medium', 'low');
            badge.classList.remove('bg-high', 'bg-medium', 'bg-low');

            // è¿™é‡Œçš„å­—æ®µåè¦å’Œä½  C++ è¿”å›çš„ JSON å­—æ®µä¸€è‡´
            const risk = (aiJson.risk_level || 'low').toLowerCase();
            box.classList.add(risk);
            badge.classList.add('bg-' + risk);
            badge.innerText = risk.toUpperCase();

            document.getElementById('summaryText').innerText = aiJson.summary || "æ— æ‘˜è¦";
            document.getElementById('rootCauseText').innerText = aiJson.root_cause || "æœªè¯†åˆ«";
            document.getElementById('solutionText').innerText = aiJson.solution || "æ— å»ºè®®";
        }

        function setLoading(isLoading) {
            document.getElementById('btnSubmit').disabled = isLoading;
            document.getElementById('btnSubmit').innerText = isLoading ? "â³ å¤„ç†ä¸­..." : "ğŸš€ å¼€å§‹åˆ†æ";
        }

        function resetResult() {
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('summaryText').innerText = "";
        }
    </script>
</body>
</html>