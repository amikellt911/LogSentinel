<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogSentinel 控制台</title>
    
    <!-- 1. 样式库：Bootstrap 5 + Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- 2. 逻辑库：Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 3. 图表库：ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>

    <style>
        body { height: 100vh; overflow: hidden; background-color: #f4f6f9; }
        
        /* 侧边栏样式 */
        .sidebar {
            width: 250px;
            background-color: #343a40;
            color: #fff;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
        }
        .sidebar-header { padding: 20px; font-size: 1.5rem; font-weight: bold; border-bottom: 1px solid #4b545c; }
        .nav-link { color: #c2c7d0; padding: 12px 20px; cursor: pointer; transition: all 0.3s; }
        .nav-link:hover, .nav-link.active { background-color: #007bff; color: #fff; }
        .nav-link i { margin-right: 10px; }

        /* 主内容区 */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
        }

        /* 卡片通用 */
        .card { border: none; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* 风险等级标签 */
        .badge-high { background-color: #dc3545; }
        .badge-medium { background-color: #ffc107; color: #000; }
        .badge-low { background-color: #28a745; }

        /* 聊天窗口 */
        .chat-box { height: 60vh; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;}
        .chat-msg { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 80%; }
        .msg-ai { background: #e9ecef; align-self: flex-start; }
        .msg-user { background: #007bff; color: white; margin-left: auto; }
    </style>
</head>
<body>

<div id="app">
    <div class="d-flex">
        <!-- 左侧菜单 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="bi bi-shield-check"></i> LogSentinel
            </div>
            <nav class="mt-3">
                <a class="nav-link" :class="{ active: currentTab === 'dashboard' }" @click="switchTab('dashboard')">
                    <i class="bi bi-speedometer2"></i> 仪表盘
                </a>
                <a class="nav-link" :class="{ active: currentTab === 'history' }" @click="switchTab('history')">
                    <i class="bi bi-table"></i> 历史日志
                </a>
                <a class="nav-link" :class="{ active: currentTab === 'chat' }" @click="switchTab('chat')">
                    <i class="bi bi-robot"></i> 智能问答
                </a>
                <a class="nav-link" :class="{ active: currentTab === 'submit' }" @click="switchTab('submit')">
                    <i class="bi bi-lightning-charge"></i> 实时测试
                </a>
            </nav>
        </div>

        <!-- 右侧内容 -->
        <div class="main-content w-100">
            
            <!-- 页面 1: 仪表盘 -->
            <div v-if="currentTab === 'dashboard'">
                <h3 class="mb-4">系统概览 (Mock Data)</h3>
                <div class="row">
                    <div class="col-md-3">
                        <div class="card p-3 text-center">
                            <h1 class="text-primary display-4 fw-bold">1,240</h1>
                            <span class="text-muted">今日分析总数</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 text-center">
                            <h1 class="text-danger display-4 fw-bold">15</h1>
                            <span class="text-muted">高危告警</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 text-center">
                            <h1 class="text-success display-4 fw-bold">98.5%</h1>
                            <span class="text-muted">系统健康度</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 text-center">
                            <h1 class="text-warning display-4 fw-bold">245ms</h1>
                            <span class="text-muted">平均响应时间</span>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5>风险分布趋势</h5>
                            <!-- ECharts 容器 -->
                            <div id="riskChart" style="width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5>最近告警</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center" v-for="alert in mockAlerts">
                                    <span>
                                        <span class="badge badge-high me-2">HIGH</span>
                                        {{ alert.summary }}
                                    </span>
                                    <span class="text-muted small">{{ alert.time }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 页面 2: 历史记录 -->
            <div v-if="currentTab === 'history'">
                <h3 class="mb-4">全量日志列表 (Mock Data)</h3>
                <div class="card">
                    <div class="card-body">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>Trace ID</th>
                                    <th>风险等级</th>
                                    <th>摘要</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="log in mockLogs" :key="log.id">
                                    <td>{{ log.time }}</td>
                                    <td><code>{{ log.trace_id }}</code></td>
                                    <td>
                                        <span class="badge" :class="'badge-' + log.risk_level">
                                            {{ log.risk_level.toUpperCase() }}
                                        </span>
                                    </td>
                                    <td>{{ log.summary }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">详情</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 页面 3: 智能问答 (RAG Demo) -->
            <div v-if="currentTab === 'chat'">
                <h3 class="mb-4">AI 运维助手 (Mock Demo)</h3>
                <div class="card">
                    <div class="card-body">
                        <div class="chat-box d-flex flex-column mb-3">
                            <div v-for="(msg, index) in chatMessages" :key="index" 
                                 class="chat-msg" :class="msg.role === 'user' ? 'msg-user' : 'msg-ai'">
                                <strong>{{ msg.role === 'user' ? '我' : 'Sentinel AI' }}:</strong>
                                <p class="mb-0">{{ msg.content }}</p>
                            </div>
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="输入问题，例如：昨天有没有发生数据库错误？" v-model="chatInput" @keyup.enter="sendChat">
                            <button class="btn btn-primary" @click="sendChat">发送</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 页面 4: 实时测试 (真实的 API 调用) -->
            <div v-if="currentTab === 'submit'">
                <h3 class="mb-4">实时日志分析测试</h3>
                <div class="card">
                    <div class="card-body">
                        <textarea v-model="liveInput" class="form-control mb-3" rows="4" placeholder="输入一条真实日志进行测试..."></textarea>
                        <button @click="submitRealLog" :disabled="isProcessing" class="btn btn-primary">
                            <span v-if="isProcessing" class="spinner-border spinner-border-sm"></span>
                            {{ isProcessing ? '分析中...' : '提交分析' }}
                        </button>
                    </div>
                </div>

                <div v-if="liveResult" class="card border-start border-5" :class="getRiskBorderClass(liveResult.risk_level)">
                    <div class="card-body">
                        <h5>分析结果</h5>
                        <p><strong>Trace ID:</strong> {{ liveTraceId }}</p>
                        <p><strong>Summary:</strong> {{ liveResult.summary }}</p>
                        <p><strong>Root Cause:</strong> {{ liveResult.root_cause }}</p>
                        <div class="alert alert-secondary">{{ liveResult.solution }}</div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const { createApp, nextTick } = Vue;
    const API_BASE = "http://127.0.0.1:8080";

    createApp({
        data() {
            return {
                currentTab: 'dashboard',
                
                // --- Mock 数据区域 (未来会被后端 API 替换) ---
                mockLogs: [
                    { id: 1, time: "2025-11-25 10:00:01", trace_id: "req-001", risk_level: "high", summary: "数据库连接超时 (Connection Timeout)" },
                    { id: 2, time: "2025-11-25 10:05:23", trace_id: "req-002", risk_level: "low", summary: "用户登录成功" },
                    { id: 3, time: "2025-11-25 10:12:45", trace_id: "req-003", risk_level: "medium", summary: "API 响应延迟 > 2s" },
                    { id: 4, time: "2025-11-25 11:00:00", trace_id: "req-004", risk_level: "high", summary: "支付服务空指针异常 (NPE)" },
                    { id: 5, time: "2025-11-25 11:20:11", trace_id: "req-005", risk_level: "low", summary: "定时任务执行完成" },
                ],
                mockAlerts: [
                    { summary: "Critical: DB Connection Lost", time: "10 mins ago" },
                    { summary: "Error: Payment Gateway 502", time: "2 hours ago" }
                ],
                chatMessages: [
                    { role: "ai", content: "你好！我是 LogSentinel 智能助手。你可以问我任何关于系统日志的问题。" }
                ],
                chatInput: "",

                // --- 实时测试数据 ---
                liveInput: "",
                isProcessing: false,
                liveTraceId: "",
                liveResult: null,
                pollTimer: null
            }
        },
        methods: {
            switchTab(tab) {
                this.currentTab = tab;
                // 如果切到仪表盘，需要重新渲染图表
                if (tab === 'dashboard') {
                    nextTick(() => {
                        this.initChart();
                    });
                }
            },
            initChart() {
                const chartDom = document.getElementById('riskChart');
                if(!chartDom) return;
                const myChart = echarts.init(chartDom);
                const option = {
                    tooltip: { trigger: 'item' },
                    legend: { top: '5%', left: 'center' },
                    series: [
                        {
                            name: '风险等级',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                            label: { show: false, position: 'center' },
                            emphasis: { label: { show: true, fontSize: 20, fontWeight: 'bold' } },
                            data: [
                                { value: 15, name: 'High', itemStyle: { color: '#dc3545' } },
                                { value: 45, name: 'Medium', itemStyle: { color: '#ffc107' } },
                                { value: 120, name: 'Low', itemStyle: { color: '#198754' } }
                            ]
                        }
                    ]
                };
                myChart.setOption(option);
            },
            sendChat() {
                if(!this.chatInput.trim()) return;
                // 1. 用户消息上屏
                this.chatMessages.push({ role: "user", content: this.chatInput });
                const question = this.chatInput;
                this.chatInput = "";

                // 2. 模拟 AI 回复 (Mock)
                setTimeout(() => {
                    let reply = "这是一个模拟回复。未来我将连接后端 RAG 接口回答关于 '" + question + "' 的问题。";
                    this.chatMessages.push({ role: "ai", content: reply });
                }, 1000);
            },
            
            // --- 真实 API 调用逻辑 (复用之前的) ---
            async submitRealLog() {
                if (!this.liveInput.trim()) return;
                this.isProcessing = true;
                this.liveResult = null;

                try {
                    const res = await fetch(`${API_BASE}/logs`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ msg: this.liveInput })
                    });
                    if (!res.ok) throw new Error("Server Error");
                    const data = await res.json();
                    this.liveTraceId = data.trace_id;
                    this.startPolling(data.trace_id);
                } catch (e) {
                    alert(e.message);
                    this.isProcessing = false;
                }
            },
            startPolling(traceId) {
                if (this.pollTimer) clearInterval(this.pollTimer);
                let attempts = 0;
                this.pollTimer = setInterval(async () => {
                    attempts++;
                    try {
                        const res = await fetch(`${API_BASE}/results/${traceId}`);
                        if (res.status === 200) {
                            const data = await res.json();
                            this.liveResult = data.result; // AI 结果
                            this.isProcessing = false;
                            clearInterval(this.pollTimer);
                        } else if (res.status === 404) {
                            console.log("Waiting...");
                        }
                    } catch(e) { console.error(e); }
                    
                    if (attempts > 30) {
                        this.isProcessing = false;
                        clearInterval(this.pollTimer);
                        alert("Timeout");
                    }
                }, 1000);
            },
            getRiskBorderClass(risk) {
                if (risk === 'high') return 'border-danger';
                if (risk === 'medium') return 'border-warning';
                return 'border-success';
            }
        },
        mounted() {
            // 默认初始化图表
            this.initChart();
        }
    }).mount('#app');
</script>

</body>
</html>