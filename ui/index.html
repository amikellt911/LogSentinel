<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogSentinel æ§åˆ¶å°</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { height: 100vh; overflow: hidden; background-color: #f4f6f9; }
        .sidebar { width: 250px; background-color: #343a40; color: #fff; display: flex; flex-direction: column; height: 100vh; position: fixed; }
        .sidebar-header { padding: 20px; font-size: 1.5rem; font-weight: bold; border-bottom: 1px solid #4b545c; }
        .nav-link { color: #c2c7d0; padding: 12px 20px; cursor: pointer; transition: all 0.3s; }
        .nav-link:hover, .nav-link.active { background-color: #007bff; color: #fff; }
        .nav-link i { margin-right: 10px; }
        .main-content { margin-left: 250px; padding: 20px; height: 100vh; overflow-y: auto; }
        .card { border: none; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .badge-high { background-color: #dc3545; }
        .badge-medium { background-color: #ffc107; color: #000; }
        .badge-low { background-color: #28a745; }
        .badge-info { background-color: #0dcaf0; color: #000; }
        .badge-unknown { background-color: #6c757d; }
        
        /* è¯¦æƒ…å¼¹çª—æ ·å¼ */
        .modal-header { border-bottom: none; }
        .detail-label { font-weight: bold; color: #6c757d; font-size: 0.9rem; }
        .detail-content { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #dee2e6; }

        /* èŠå¤©çª—å£æ ·å¼ (æ¢å¤) */
        .chat-box { height: 60vh; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        .chat-msg { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 80%; }
        .msg-ai { background: #e9ecef; align-self: flex-start; }
        .msg-user { background: #007bff; color: white; margin-left: auto; }
        /* æ–°å¢ï¼šä»ªè¡¨ç›˜æ¦‚è§ˆå¡ç‰‡ä¸“ç”¨æ ·å¼ */
        .overview-card {
            height: 160px; /* 1. å¼ºåˆ¶å›ºå®šé«˜åº¦ï¼Œç¡®ä¿æ‰€æœ‰å¡ç‰‡ä¸€æ ·é«˜ */
            display: flex;
            flex-direction: column;
            justify-content: center; /* 2. å†…å®¹å‚ç›´å±…ä¸­ */
            align-items: center;
        }

        /* é˜²æ­¢æ ‡ç­¾æ–‡å­—æ¢è¡Œ */
        .overview-card .text-muted {
            white-space: nowrap; /* 3. å¼ºåˆ¶æ–‡å­—ä¸æ¢è¡Œ */
            overflow: hidden;
            text-overflow: ellipsis; /* ä¸‡ä¸€å¤ªé•¿æ˜¾ç¤ºçœç•¥å·ï¼Œä¸æ’‘å¼€å¸ƒå±€ */
            max-width: 100%;
        }
    </style>
</head>

<body>

    <div id="app">
        <div class="d-flex">
            <div class="sidebar">
                <div class="sidebar-header">
                    <i class="bi bi-shield-check"></i> LogSentinel
                </div>
                <nav class="mt-3">
                    <a class="nav-link" :class="{ active: currentTab === 'dashboard' }" @click="switchTab('dashboard')">
                        <i class="bi bi-speedometer2"></i> ä»ªè¡¨ç›˜
                    </a>
                    <a class="nav-link" :class="{ active: currentTab === 'history' }" @click="switchTab('history')">
                        <i class="bi bi-table"></i> å†å²æ—¥å¿—
                    </a>
                    <a class="nav-link" :class="{ active: currentTab === 'chat' }" @click="switchTab('chat')">
                        <i class="bi bi-robot"></i> æ™ºèƒ½é—®ç­”
                    </a>
                    <a class="nav-link" :class="{ active: currentTab === 'submit' }" @click="switchTab('submit')">
                        <i class="bi bi-lightning-charge"></i> å®æ—¶æµ‹è¯•
                    </a>
                </nav>
            </div>

            <div class="main-content w-100">

                <div v-if="currentTab === 'dashboard'">
                    <h3 class="mb-4">ç³»ç»Ÿæ¦‚è§ˆ (Realtime)</h3>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card p-3 text-center overview-card">
                                <h1 class="text-primary display-4 fw-bold">{{ stats.total }}</h1>
                                <span class="text-muted">ä»Šæ—¥åˆ†ææ€»æ•°</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card p-3 text-center overview-card">
                                <h1 class="text-danger display-4 fw-bold">{{ stats.high }}</h1>
                                <span class="text-muted">é«˜å±å‘Šè­¦</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card p-3 text-center overview-card">
                                <h1 class="text-success display-4 fw-bold">{{ stats.health }}</h1>
                                <span class="text-muted">ç³»ç»Ÿå¥åº·åº¦</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card p-3 text-center overview-card">
                                <h1 class="text-warning display-4 fw-bold">{{ stats.avg_time }}</h1>
                                <span class="text-muted">å¹³å‡å“åº”æ—¶é—´</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card p-3">
                                <h5>é£é™©åˆ†å¸ƒè¶‹åŠ¿</h5>
                                <div id="riskChart" style="width: 100%; height: 300px;"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3">
                                <h5>æœ€è¿‘å‘Šè­¦</h5>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center"
                                        v-for="alert in recentAlerts" :key="alert.trace_id">
                                        <span class="text-truncate" style="max-width: 70%;">
                                            <span class="badge badge-high me-2">HIGH</span>
                                            {{ alert.summary }}
                                        </span>
                                        <span class="text-muted small" :title="alert.time">{{ formatTimeAgo(alert.time) }}</span>
                                    </li>
                                    <li v-if="recentAlerts.length === 0" class="list-group-item text-center text-muted">
                                        æš‚æ— é«˜å±å‘Šè­¦ï¼Œç³»ç»Ÿè¿è¡Œè‰¯å¥½ ğŸ‰
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'history'">
                    <h3 class="mb-4">å†å²æ—¥å¿—æŸ¥è¯¢</h3>
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <span>å…±æ‰¾åˆ° <strong>{{ history.total }}</strong> æ¡è®°å½•</span>
                                <button class="btn btn-sm btn-outline-secondary" @click="fetchHistory(history.page)">
                                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                                </button>
                            </div>

                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th style="width: 180px;">å¤„ç†æ—¶é—´</th>
                                        <th style="width: 100px;">é£é™©ç­‰çº§</th>
                                        <th>æ‘˜è¦</th>
                                        <th style="width: 150px;">Trace ID</th>
                                        <th style="width: 100px;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="history.loading">
                                        <td colspan="5" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status"></div>
                                            <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½æ—¥å¿—...</p>
                                        </td>
                                    </tr>
                                    <tr v-else-if="history.logs.length === 0">
                                        <td colspan="5" class="text-center py-4 text-muted">æš‚æ— æ—¥å¿—æ•°æ®</td>
                                    </tr>
                                    <tr v-else v-for="log in history.logs" :key="log.trace_id">
                                        <td>{{ log.processed_at }}</td>
                                        <td>
                                            <span class="badge" :class="getBadgeClass(log.risk_level)">
                                                {{ (log.risk_level || 'UNKNOWN').toUpperCase() }}
                                            </span>
                                        </td>
                                        <td class="text-truncate" style="max-width: 300px;" :title="log.summary">
                                            {{ log.summary }}
                                        </td>
                                        <td><code>{{ log.trace_id.substring(0, 8) }}...</code></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" @click="showDetails(log.trace_id)">
                                                è¯¦æƒ…
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <nav v-if="history.total > 0">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" :class="{ disabled: history.page <= 1 }">
                                        <a class="page-link" href="#" @click.prevent="changePage(history.page - 1)">ä¸Šä¸€é¡µ</a>
                                    </li>
                                    <li class="page-item disabled">
                                        <span class="page-link">ç¬¬ {{ history.page }} é¡µ</span>
                                    </li>
                                    <li class="page-item" :class="{ disabled: history.logs.length < history.pageSize }">
                                        <a class="page-link" href="#" @click.prevent="changePage(history.page + 1)">ä¸‹ä¸€é¡µ</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'chat'">
                    <h3 class="mb-4">AI è¿ç»´åŠ©æ‰‹ (Mock Demo)</h3>
                    <div class="card">
                        <div class="card-body">
                            <div class="chat-box d-flex flex-column mb-3">
                                <div v-for="(msg, index) in chatMessages" :key="index" class="chat-msg"
                                    :class="msg.role === 'user' ? 'msg-user' : 'msg-ai'">
                                    <strong>{{ msg.role === 'user' ? 'æˆ‘' : 'Sentinel AI' }}:</strong>
                                    <p class="mb-0">{{ msg.content }}</p>
                                </div>
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="è¾“å…¥é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæ˜¨å¤©æœ‰æ²¡æœ‰å‘ç”Ÿæ•°æ®åº“é”™è¯¯ï¼Ÿ"
                                    v-model="chatInput" @keyup.enter="sendChat">
                                <button class="btn btn-primary" @click="sendChat">å‘é€</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'submit'">
                    <h3 class="mb-4">å®æ—¶æ—¥å¿—åˆ†ææµ‹è¯•</h3>
                    <div class="card">
                        <div class="card-body">
                            <textarea v-model="liveInput" class="form-control mb-3" rows="4"
                                placeholder="è¾“å…¥ä¸€æ¡çœŸå®æ—¥å¿—è¿›è¡Œæµ‹è¯•..."></textarea>
                            <button @click="submitRealLog" :disabled="isProcessing" class="btn btn-primary">
                                <span v-if="isProcessing" class="spinner-border spinner-border-sm"></span>
                                {{ isProcessing ? 'åˆ†æä¸­...' : 'æäº¤åˆ†æ' }}
                            </button>
                        </div>
                    </div>

                    <div v-if="liveResult" class="card border-start border-5 mt-3"
                        :class="getRiskBorderClass(liveResult.risk_level)">
                        <div class="card-body">
                            <h5>åˆ†æç»“æœ</h5>
                            <p><strong>Trace ID:</strong> {{ liveTraceId }}</p>
                            <p><strong>Summary:</strong> {{ liveResult.summary }}</p>
                            <p><strong>Root Cause:</strong> {{ liveResult.root_cause }}</p>
                            <div class="alert alert-secondary">{{ liveResult.solution }}</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-truncate" style="font-family: monospace; max-width: 95%;" :title="selectedLog ? selectedLog.trace_id : ''">
                            Trace ID: {{ selectedLog ? selectedLog.trace_id : '' }}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body" v-if="selectedLog">
                        <div class="mb-3">
                            <div class="detail-label">æ ¹æœ¬åŸå›  (Root Cause)</div>
                            <div class="detail-content">{{ selectedLog.result.root_cause }}</div>
                        </div>

                        <div class="mb-3">
                            <div class="detail-label">è§£å†³æ–¹æ¡ˆ (Solution)</div>
                            <div class="detail-content">
                                {{ selectedLog.result.solution }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="detail-label">æ‘˜è¦ (Summary)</div>
                            <div class="detail-content">{{ selectedLog.result.summary }}</div>
                        </div>
                    </div>

                    <div class="modal-body text-center" v-else>
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, nextTick } = Vue;
        const API_BASE = "http://127.0.0.1:8080";

        createApp({
            data() {
                return {
                    currentTab: 'dashboard',
                    // ä»ªè¡¨ç›˜æ•°æ®
                    stats: { total: 0, high: 0, medium: 0, low: 0,info:0,unknown:0, health: "100%", avg_time: "0ms" },
                    recentAlerts: [],
                    
                    // å†å²æ—¥å¿—æ•°æ®
                    history: {
                        logs: [],
                        page: 1,
                        pageSize: 10,
                        total: 0,
                        loading: false
                    },
                    
                    // èŠå¤©æ•°æ® (æ¢å¤)
                    chatMessages: [
                        { role: "ai", content: "ä½ å¥½ï¼æˆ‘æ˜¯ LogSentinel æ™ºèƒ½åŠ©æ‰‹ã€‚ä½ å¯ä»¥é—®æˆ‘ä»»ä½•å…³äºç³»ç»Ÿæ—¥å¿—çš„é—®é¢˜ã€‚" }
                    ],
                    chatInput: "",

                    // è¯¦æƒ…å¼¹çª—æ•°æ®
                    selectedLog: null,
                    detailModal: null, 

                    // å®æ—¶æµ‹è¯•æ•°æ®
                    liveInput: "",
                    isProcessing: false,
                    liveTraceId: "",
                    liveResult: null,
                    pollTimer: null
                }
            },
            methods: {
                switchTab(tab) {
                    this.currentTab = tab;
                    if (tab === 'dashboard') {
                        nextTick(() => this.initChart());
                    } else if (tab === 'history') {
                        this.fetchHistory(1);
                    }
                },
                
                // --- å†å²æ—¥å¿—ç›¸å…³ ---
                async fetchHistory(page) {
                    this.history.loading = true;
                    this.history.page = page; 
                    try {
                        const res = await fetch(`${API_BASE}/history?page=${page}&pageSize=${this.history.pageSize}`);
                        if (res.ok) {
                            const data = await res.json();
                            this.history.logs = data.logs || [];
                            this.history.total = data.total_count || 0;
                        } else {
                            console.error("Fetch history failed");
                        }
                    } catch (e) {
                        console.error("Network error:", e);
                    } finally {
                        this.history.loading = false;
                    }
                },
                changePage(newPage) {
                    if (newPage < 1) return;
                    this.fetchHistory(newPage);
                },
                
                // --- è¯¦æƒ…ç›¸å…³ ---
                async showDetails(traceId) {
                    this.selectedLog = null;
                    if (!this.detailModal) {
                        this.detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
                    }
                    this.detailModal.show();
                    try {
                        const res = await fetch(`${API_BASE}/results/${traceId}`);
                        if (res.ok) {
                            const data = await res.json();
                            this.selectedLog = data;
                        } else {
                            alert("è·å–è¯¦æƒ…å¤±è´¥");
                        }
                    } catch (e) {
                        console.error(e);
                        alert("ç½‘ç»œé”™è¯¯");
                    }
                },

                // --- èŠå¤©ç›¸å…³ (æ¢å¤) ---
                sendChat() {
                    if (!this.chatInput.trim()) return;
                    this.chatMessages.push({ role: "user", content: this.chatInput });
                    const question = this.chatInput;
                    this.chatInput = "";
                    setTimeout(() => {
                        let reply = "è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå›å¤ã€‚æœªæ¥æˆ‘å°†è¿æ¥åç«¯ RAG æ¥å£å›ç­”å…³äº '" + question + "' çš„é—®é¢˜ã€‚";
                        this.chatMessages.push({ role: "ai", content: reply });
                    }, 1000);
                },

                // --- è¾…åŠ©æ ·å¼ ---
                getBadgeClass(risk) {
                    risk = (risk || '').toLowerCase();
                    if (risk === 'high') return 'badge-high';
                    if (risk === 'medium') return 'badge-medium';
                    if (risk === 'low') return 'badge-low';
                    if (risk === 'info') return 'badge-info';
                    return 'badge-unknown';
                },
                getRiskBorderClass(risk) {
                    if (risk === 'high') return 'border-danger';
                    if (risk === 'medium') return 'border-warning';
                    return 'border-success';
                },
                formatTimeAgo(timeString) {
                    if (!timeString) return '';
                    let utcString = timeString.replace(' ', 'T');
                    if (!utcString.endsWith('Z')) utcString += 'Z';
                    const date = new Date(utcString);
                    const now = new Date();
                    const diff = Math.floor((now - date) / 1000);
                    if (isNaN(diff)) return timeString;
                    if (diff < 60) return 'åˆšåˆš';
                    if (diff < 3600) return Math.floor(diff / 60) + ' åˆ†é’Ÿå‰';
                    if (diff < 86400) return Math.floor(diff / 3600) + ' å°æ—¶å‰';
                    return Math.floor(diff / 86400) + ' å¤©å‰';
                },

                // --- ä»ªè¡¨ç›˜ç›¸å…³ ---
                initChart() {
                    const chartDom = document.getElementById('riskChart');
                    if (!chartDom) return;
                    const myChart = echarts.getInstanceByDom(chartDom) || echarts.init(chartDom);
                    const option = {
                        tooltip: { trigger: 'item' },
                        legend: { top: '5%', left: 'center' },
                        series: [
                            {
                                name: 'é£é™©ç­‰çº§',
                                type: 'pie',
                                radius: ['40%', '70%'],
                                avoidLabelOverlap: false,
                                itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                                label: { show: false, position: 'center' },
                                emphasis: { label: { show: true, fontSize: 20, fontWeight: 'bold' } },
                                data: [
                                { value: this.stats.high, name: 'High', itemStyle: { color: '#dc3545' } },
                                { value: this.stats.medium, name: 'Medium', itemStyle: { color: '#ffc107' } },
                                { value: this.stats.low, name: 'Low', itemStyle: { color: '#198754' } },
                                { value: this.stats.info, name: 'Info', itemStyle: { color: '#0dcaf0' } },
                                { value: this.stats.unknown, name: 'Unknown', itemStyle: { color: '#6c757d' } }
                                ]
                            }
                        ]
                    };
                    myChart.setOption(option);
                },
                async fetchDashboardData() {
                    try {
                        const res = await fetch(`${API_BASE}/dashboard`);
                        if (res.status === 200) {
                            const data = await res.json();
                            this.stats = {
                                total: data.total_logs,
                                high: data.high_risk,
                                medium: data.medium_risk,
                                low: data.low_risk,
                                info: data.info_risk || 0,
                                unknown: data.unknown_risk || 0,
                                health: (100 - ((data.high_risk / (data.total_logs || 1)) * 100)).toFixed(1) + "%",
                                avg_time: (data.avg_response_time / 1000).toFixed(1) + "ms"
                            };
                            this.recentAlerts = data.recent_alerts || [];
                            this.updateChart();
                        }
                    } catch (e) { console.error("ä»ªè¡¨ç›˜åŠ è½½å¤±è´¥", e); }
                },
                updateChart() {
                    this.initChart();
                },

                // --- å®æ—¶æµ‹è¯•ç›¸å…³ ---
                async submitRealLog() {
                    if (!this.liveInput.trim()) return;
                    this.isProcessing = true;
                    this.liveResult = null;
                    try {
                        const res = await fetch(`${API_BASE}/logs`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ msg: this.liveInput })
                        });
                        if (!res.ok) throw new Error("Server Error");
                        const data = await res.json();
                        this.liveTraceId = data.trace_id;
                        this.startPolling(data.trace_id);
                    } catch (e) { alert(e.message); this.isProcessing = false; }
                },
                startPolling(traceId) {
                    if (this.pollTimer) clearInterval(this.pollTimer);
                    let attempts = 0;
                    this.pollTimer = setInterval(async () => {
                        attempts++;
                        try {
                            const res = await fetch(`${API_BASE}/results/${traceId}`);
                            if (res.status === 200) {
                                const data = await res.json();
                                this.liveResult = data.result;
                                this.isProcessing = false;
                                clearInterval(this.pollTimer);
                            } else if (res.status === 404) { console.log("Waiting..."); }
                        } catch (e) { console.error(e); }
                        if (attempts > 30) { this.isProcessing = false; clearInterval(this.pollTimer); alert("Timeout"); }
                    }, 1000);
                }
            },
            mounted() {
                this.fetchDashboardData();
                setInterval(() => {
                    if (this.currentTab === 'dashboard') this.fetchDashboardData();
                }, 5000);
                window.addEventListener('resize', () => {
                    const chartDom = document.getElementById('riskChart');
                    if (chartDom) echarts.getInstanceByDom(chartDom)?.resize();
                });
            }
        }).mount('#app');
    </script>

</body>
</html>